generator client {
  provider = "prisma-client"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

model User {
  id           String   @id @default(cuid())
  email        String   @unique
  passwordHash String
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  projects     Project[]
}

model Project {
  id        String   @id @default(cuid())
  user      User     @relation(fields: [userId], references: [id])
  userId    String
  name      String
  apiKey    String   @unique
  provider  String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  messages   Message[]
  memories   Memory[]
  entities   Entity[]
  relations  Relation[]

  @@index([userId])
}

model ProviderKey {
  id           String   @id @default(cuid())
  provider     String   @unique
  encryptedKey String
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
}

model Message {
  id        String   @id @default(cuid())
  project   Project  @relation(fields: [projectId], references: [id])
  projectId String
  role      String
  content   String
  createdAt DateTime @default(now())

  memories Memory[]

  @@index([projectId, createdAt(sort: Desc)])
}

model Memory {
  id              String           @id @default(cuid())
  project         Project          @relation(fields: [projectId], references: [id])
  projectId       String
  type            String
  text            String
  importance      Float?
  confidence      Float?
  status          String           @default("active")
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
  sourceMessage   Message?         @relation(fields: [sourceMessageId], references: [id])
  sourceMessageId String?

  embedding MemoryEmbedding?
  relations Relation[]        @relation("RelationEvidence")
  mentions  EntityMention[]

  @@index([projectId, createdAt(sort: Desc)])
}

model MemoryEmbedding {
  memory     Memory @relation(fields: [memoryId], references: [id])
  memoryId   String @id
  embedding  Unsupported("vector")
}

model Entity {
  id             String          @id @default(cuid())
  project        Project         @relation(fields: [projectId], references: [id])
  projectId      String
  name           String
  normalizedName String
  kind           String
  createdAt      DateTime        @default(now())

  mentions  EntityMention[]
  subjectOf Relation[] @relation("SubjectEntity")
  objectOf  Relation[] @relation("ObjectEntity")

  @@unique([projectId, normalizedName, kind])
  @@index([projectId])
}

model Relation {
  id               String   @id @default(cuid())
  project          Project  @relation(fields: [projectId], references: [id])
  projectId        String
  subjectEntity    Entity   @relation("SubjectEntity", fields: [subjectEntityId], references: [id])
  subjectEntityId  String
  predicate        String
  objectEntity     Entity   @relation("ObjectEntity", fields: [objectEntityId], references: [id])
  objectEntityId   String
  confidence       Float?
  evidenceMemory   Memory   @relation("RelationEvidence", fields: [evidenceMemoryId], references: [id])
  evidenceMemoryId String
  createdAt        DateTime @default(now())

  @@index([projectId])
}

model EntityMention {
  id        String  @id @default(cuid())
  entity    Entity  @relation(fields: [entityId], references: [id])
  entityId  String
  memory    Memory  @relation(fields: [memoryId], references: [id])
  memoryId  String
}

